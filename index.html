<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SD Prompt Manager Ultimate (v40 EditUI)</title>
<style>
  /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
  :root {
    --bg-main: #1e1e2e; --bg-panel: #2a2b3d; --bg-group: #252636; --bg-input: #181825;
    --text-main: #e0e0e0; --text-muted: #a0a0a0; --border-col: #444;
    --accent-color: #3b82f6; --danger-color: #ef4444; --btn-text: #fff;
    --edit-color: #f59e0b; --ctrl-bg: #181825;
    
    /* „Ç´„ÉÜ„Ç¥„É™Ëâ≤ */
    --col-quality: #4ade80; --col-style: #c084fc; --col-color: #d946ef; --col-pattern: #8b5cf6; --col-neg: #ef4444;
    --col-comp: #2dd4bf; --col-expr: #fbbf24; --col-bg: #34d399; --col-camera: #fb7185; --col-pose: #22d3ee;
    --col-cloth-top: #fca5a5; --col-cloth-outer: #f87171; --col-cloth-btm: #fb923c; --col-cloth-dress: #f472b6;
    --col-cloth-cos: #db2777; --col-cloth-jp: #d946ef; --col-cloth-in: #f43f5e; --col-cloth-detail: #fdba74; --col-cloth-leg: #fcd34d; --col-skin: #fda4af;
    --col-acc-head: #60a5fa; --col-acc-face: #818cf8; --col-acc-body: #34d399; --col-acc-extra: #a3e635;
  }

  body.light-mode {
    --bg-main: #f3f4f6; --bg-panel: #ffffff; --bg-group: #e5e7eb; --bg-input: #f9fafb;
    --text-main: #1f2937; --text-muted: #6b7280; --border-col: #d1d5db; --accent-color: #2563eb; --ctrl-bg: #ffffff;
  }
  
  body {
    background-color: var(--bg-main); color: var(--text-main); font-family: "Segoe UI", Meiryo, sans-serif;
    margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center;
    padding-bottom: 200px; transition: background-color 0.3s, color 0.3s;
  }

  /* --- Edit Mode (Êû†Á∑öÂæ©Ê¥ª & Ë™øÊï¥) --- */
  
  /* ÈÄöÂ∏∏ÊôÇ„ÅÆ„Éú„Éº„ÉÄ„Éº„ÅØÈÄèÊòé„Å´Ëøë„ÅÑË®≠ÂÆö */
  .group-box, .category-box { border: 1px solid var(--border-col); transition: all 0.2s; }
  
  /* ‚òÖÁ∑®ÈõÜ„É¢„Éº„ÉâONÊôÇ„ÅÆ„Çπ„Çø„Ç§„É´‚òÖ */
  /* „Ç∞„É´„Éº„ÉóÊû†: Á¥∞„ÅÑ„Ç™„É¨„É≥„Ç∏ÁÇπÁ∑ö */
  body.is-editing .group-box {
    border: 1px dashed var(--edit-color);
    background-color: rgba(245, 158, 11, 0.03);
  }
  /* „Ç´„ÉÜ„Ç¥„É™Êû†: „Åï„Çâ„Å´Á¥∞„ÅÑÁÇπÁ∑ö */
  body.is-editing .category-box {
    border: 1px dashed rgba(245, 158, 11, 0.6);
  }
  /* „Çø„Ç∞: Á¥∞„ÅÑ„Ç™„É¨„É≥„Ç∏ÁÇπÁ∑ö */
  body.is-editing .library-tag {
    cursor: grab !important;
    border: 1px dashed var(--edit-color) !important;
    opacity: 1;
  }
  body.is-editing .library-tag:hover {
    background-color: rgba(245, 158, 11, 0.2);
  }
  
  /* „Åù„ÅÆ‰ªñÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆË®≠ÂÆö */
  body.is-editing .category-title, body.is-editing .group-header { cursor: grab !important; user-select: none; }
  body.is-editing .btn-random-pick { display: none; }
  
  .drag-handle { display: none; cursor: grab; color: var(--edit-color); margin-right: 8px; font-size: 1.1rem; padding: 0 2px; }
  body.is-editing .drag-handle { display: inline-block; }

  .edit-actions { display: none; gap: 5px; align-items: center; margin-left: auto; }
  body.is-editing .edit-actions { display: flex; }

  .btn-icon { background: none; border: 1px solid var(--border-col); border-radius: 4px; color: var(--text-muted); cursor: pointer; padding: 4px 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .btn-icon:hover { background-color: var(--edit-color); color: #fff; border-color: var(--edit-color); }
  .btn-icon-del { font-size: 0.9rem; background: none; color: var(--danger-color); border: 1px solid var(--danger-color); border-radius: 4px; padding: 2px 6px; cursor: pointer; transition: all 0.2s; }
  .btn-icon-del:hover { background-color: var(--danger-color); color: #fff; }

  .drag-over-target { border: 2px solid var(--accent-color) !important; background-color: rgba(59, 130, 246, 0.1) !important; transition: all 0.1s; }

  /* „Éò„ÉÉ„ÉÄ„Éº„Ç®„É™„Ç¢ */
  .header-area {
    position: sticky; top: 0; z-index: 1000; width: 100%; background-color: var(--bg-main);
    border-bottom: 2px solid var(--border-col); padding: 15px 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; box-sizing: border-box; transition: background-color 0.3s;
  }
  h1 { margin: 5px 0 10px 0; font-size: 1.2rem; letter-spacing: 1px; text-align: center; }

  /* „ÉÑ„Éº„É´„Éê„Éº */
  .toolbar-container { width: 100%; max-width: 1200px; display: flex; flex-direction: column; gap: 10px; }
  .toolbar-row-main { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .search-input { flex-grow: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-col); background-color: var(--bg-input); color: var(--text-main); outline: none; font-size: 0.95rem; min-width: 200px; }
  .search-input:focus { border-color: var(--accent-color); }
  .toolbar-row-tools { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; justify-content: center; background-color: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; }

  button.action-btn {
    background-color: var(--accent-color); color: var(--btn-text); border: none;
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
    font-weight: bold; white-space: nowrap; font-size: 0.85rem; transition: filter 0.2s;
    display: flex; align-items: center; gap: 5px;
  }
  button.action-btn:hover { filter: brightness(1.1); }
  button.action-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }

  button.btn-pool { padding: 5px 10px; font-size: 0.8rem; background-color: #4b5563; }
  button.btn-clear { background-color: #4b5563; }
  button.btn-copy { background-color: #3b82f6; }
  button.btn-save { background-color: #10b981; }
  button.btn-toggle { background-color: #8b5cf6; }
  button.btn-trans { background-color: #f59e0b; }
  button.btn-free { background-color: #ec4899; }
  button.btn-wild { background-color: #14b8a6; }
  button.btn-load { background-color: #059669; }
  button.btn-theme { background-color: #6366f1; padding: 6px 10px; font-size: 1rem; }
  button.btn-edit { background-color: #64748b; margin-left: auto; transition: all 0.3s; }
  /* ‚òÖÁ∑®ÈõÜ‰∏≠„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´‚òÖ */
  button.btn-edit.active { background-color: var(--edit-color); box-shadow: 0 0 15px var(--edit-color); color: #111; transform: scale(1.05); }

  /* „Éó„Éº„É´ */
  .output-container {
    width: 100%; max-width: 1200px; background-color: var(--bg-panel); border: 1px solid var(--border-col);
    border-radius: 8px; padding: 15px; min-height: 100px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    margin-bottom: 10px; transition: background-color 0.3s; position: relative;
  }
  .output-container:focus-within { border-color: var(--accent-color); }
  .pool-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--border-col); padding-bottom: 8px; }
  .output-label { font-size: 0.8rem; color: var(--text-muted); font-weight: bold; }
  .pool-actions { display: flex; gap: 8px; }
  button.btn-undo { background-color: #6b7280; }

  /* „Ç≥„É≥„ÉÜ„É≥„ÉÑ */
  .content-area { width: 100%; max-width: 1200px; padding: 20px; box-sizing: border-box; }
  
  /* ËøΩÂä†„Éï„Ç©„Éº„É† */
  .add-section { background-color: var(--bg-panel); border: 1px solid var(--border-col); border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .add-label-title { font-size: 0.9rem; font-weight: bold; color: var(--accent-color); margin-bottom: 8px; display: block; }
  .add-form { width: 100%; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .add-select { background-color: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-col); padding: 12px; border-radius: 6px; flex: 1; min-width: 200px; }
  .add-input { flex-grow: 2; background-color: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-col); padding: 12px; border-radius: 6px; min-width: 200px; }
  button.btn-add { background-color: var(--accent-color); padding: 10px 20px; font-size: 1rem; }

  /* „Çø„Ç∞ */
  .active-tag { display: inline-flex; align-items: center; padding: 6px 10px; margin: 3px; border-radius: 20px; background-color: rgba(128,128,128,0.1); border: 1px solid var(--tag-color); color: var(--tag-color); cursor: pointer; user-select: none; font-family: monospace; font-size: 0.9rem; transition: all 0.1s; }
  .active-tag:hover { filter: brightness(1.1) contrast(1.1); }
  .active-tag.selected { background-color: var(--tag-color); color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); box-shadow: 0 0 10px var(--tag-color); font-weight: bold; transform: scale(1.05); }

  /* „Éë„Éç„É´ */
  .panel-container { display: flex; gap: 20px; width: 100%; margin-bottom: 20px; align-items: stretch; background-color: var(--bg-panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border-col); box-sizing: border-box; transition: background-color 0.3s; flex-direction: column; }
  .panel-container.hidden { display: none; }
  .free-edit-box { position: relative; display: flex; flex-direction: column; gap: 10px; }
  .free-textarea { width: 100%; height: 150px; border: 1px solid var(--border-col); border-radius: 6px; background-color: var(--bg-input); color: var(--text-main); padding: 10px; font-family: monospace; font-size: 1rem; line-height: 1.5; resize: vertical; outline: none; }
  #autocomplete-list { position: absolute; top: 100%; left: 0; z-index: 3000; background-color: var(--bg-panel); border: 1px solid var(--border-col); border-radius: 6px; max-height: 200px; overflow-y: auto; width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: none; }
  .suggestion-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--border-col); font-size: 0.9rem; display: flex; justify-content: space-between; }
  .suggestion-item:hover { background-color: var(--accent-color); color: #fff; }
  .wildcard-row { display: flex; gap: 10px; align-items: center; }
  .wild-input-name { flex: 1; padding: 10px; border-radius: 4px; background: var(--bg-input); border: 1px solid var(--border-col); color: var(--text-main); }
  .trans-box { flex: 1; display: flex; flex-direction: column; gap: 10px; }
  .trans-row { display: flex; gap: 10px; align-items: center; width: 100%; }
  .input-wrapper { position: relative; flex: 1; display: flex; }
  .trans-input { width: 100%; padding: 10px; padding-right: 30px; border-radius: 6px; border: 1px solid var(--border-col); background-color: var(--bg-input); color: var(--text-main); outline: none; font-size: 0.95rem; }
  .btn-input-clear { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; }
  .trans-result { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid var(--border-col); background-color: var(--bg-input); color: var(--col-quality); font-weight: bold; font-family: monospace; min-height: 20px; display: flex; align-items: center; word-break: break-all; }
  .inspection-container { display: flex; gap: 20px; width: 100%; align-items: stretch; flex-wrap: wrap; }
  .meta-panel { flex: 1; background-color: var(--bg-input); color: var(--text-main); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; min-height: 250px; border: 1px solid var(--border-col); }
  .meta-textarea { width: 100%; flex-grow: 1; border: 1px solid var(--border-col); border-radius: 6px; background-color: var(--bg-main); padding: 10px; font-family: monospace; font-size: 0.85rem; line-height: 1.4; resize: none; outline: none; color: var(--text-main); box-sizing: border-box; }
  .meta-actions { margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end; }
  .image-panel { width: 100%; max-width: 300px; flex-shrink: 0; display: flex; flex-direction: column; }
  .ref-box { width: 100%; height: 100%; min-height: 250px; background-color: var(--bg-input); border: 2px dashed var(--border-col); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); position: relative; overflow: hidden; box-sizing: border-box; }
  .ref-preview { width: 100%; height: 100%; object-fit: contain; display: none; }
  .btn-remove-img { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: #fff; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; z-index: 10; }
  .add-form { width: 100%; background-color: var(--bg-panel); border: 1px solid var(--border-col); padding: 15px; border-radius: 8px; display: flex; gap: 10px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; box-sizing: border-box; }
  .add-select { background-color: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-col); padding: 10px; border-radius: 4px; flex: 1; min-width: 150px; }
  .add-input { flex-grow: 2; background-color: var(--bg-input); color: var(--text-main); border: 1px solid var(--border-col); padding: 10px; border-radius: 4px; min-width: 150px; }
  button.btn-download { background-color: #10b981; }

  /* „É©„Ç§„Éñ„É©„É™ */
  .group-box { margin-bottom: 15px; border: 1px solid var(--border-col); border-radius: 8px; overflow: hidden; transition: border-color 0.3s; }
  .group-header { background-color: var(--bg-group); padding: 12px 15px; font-weight: bold; font-size: 1rem; display: flex; align-items: center; border-bottom: 1px solid transparent; color: var(--text-main); transition: background-color 0.3s; cursor: pointer; }
  .group-header:hover { background-color: rgba(255,255,255,0.05); }
  .group-icon { margin-left: auto; font-size: 0.8rem; transition: transform 0.2s; }
  .group-box.collapsed .group-body { display: none; }
  .group-box.collapsed .group-header { border-bottom: none; }
  .group-box.collapsed .group-icon { transform: rotate(-90deg); }
  .group-body { background-color: var(--bg-main); padding: 10px; display: flex; flex-direction: column; gap: 10px; }
  .category-box { background-color: var(--bg-panel); border-radius: 6px; padding: 8px; border-left: 5px solid var(--box-color); display: flex; flex-direction: column; transition: background-color 0.3s; }
  .category-box.hidden { display: none; }
  .category-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; margin: 0; color: var(--text-main); font-weight: 600; cursor: pointer; display: flex; align-items: center; padding: 5px; }
  .category-title:hover { background-color: rgba(255,255,255,0.05); border-radius: 4px; }
  .cat-icon { margin-left: auto; font-size: 0.7rem; transition: transform 0.2s; }
  .category-box.collapsed .tag-container { display: none; }
  .category-box.collapsed .cat-icon { transform: rotate(-90deg); }
  .tag-container { display: flex; flex-wrap: wrap; gap: 6px; padding-top: 8px; padding-left: 5px; min-height: 20px; }
  .library-tag { cursor: pointer; background-color: transparent; border: 1px solid var(--tag-color); color: var(--text-main); opacity: 0.9; padding: 8px 12px; border-radius: 6px; font-size: 0.9rem; position: relative; display: flex; align-items: center; gap: 5px; }
  .library-tag.hidden { display: none; }
  .btn-random-pick { background: none; border: none; cursor: pointer; font-size: 1.2rem; margin-right: 10px; transition: transform 0.1s; }
  .add-group-btn-area { text-align: center; padding: 20px; }
  .btn-add-group { width: 100%; padding: 15px; border: 2px dashed var(--border-col); border-radius: 8px; background-color: transparent; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; transition: all 0.2s; font-weight: bold; }
  .btn-add-group:hover { border-color: var(--accent-color); color: var(--accent-color); background-color: rgba(59, 130, 246, 0.1); }
  .app-footer { width: 100%; max-width: 1200px; margin-top: 40px; padding: 20px; border-top: 1px solid var(--border-col); text-align: center; color: var(--text-muted); font-size: 0.9rem; }
  .creator-name { color: var(--accent-color); font-weight: bold; font-size: 1.1rem; }
  .social-links { margin-top: 10px; }
  .social-links a { color: var(--text-main); text-decoration: none; margin: 0 10px; font-weight: bold; transition: color 0.2s; }
  .social-links a:hover { color: var(--accent-color); }

  /* Modal */
  #modal-overlay, #tag-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 6000; display: none; justify-content: center; align-items: center; }
  #modal-overlay.active, #tag-modal-overlay.active { display: flex; }
  .modal-box { background-color: var(--bg-panel); border: 1px solid var(--border-col); border-radius: 12px; padding: 25px; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 15px; color: var(--text-main); }
  .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; text-align: center; }
  .modal-input { padding: 10px; border-radius: 6px; border: 1px solid var(--border-col); background-color: var(--bg-input); color: var(--text-main); outline: none; }
  .color-picker-row { display: flex; align-items: center; gap: 10px; }
  .color-input { width: 50px; height: 40px; padding: 0; border: none; cursor: pointer; background: none; }
  .modal-btns { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }

  #controller-bar { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--ctrl-bg); border-top: 3px solid var(--accent-color); padding: 15px 10px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.3); z-index: 5000; transform: translateY(120%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  #controller-bar.visible { transform: translateY(0); }
  .ctrl-row-move { display: flex; justify-content: space-between; align-items: center; width: 100%; max-width: 600px; margin: 0 auto; }
  .ctrl-row-weight { display: flex; justify-content: center; align-items: center; gap: 20px; width: 100%; max-width: 600px; margin: 0 auto; background: rgba(128,128,128,0.1); border-radius: 30px; padding: 5px; }
  .ctrl-btn { width: 50px; height: 50px; border-radius: 12px; border: 2px solid var(--border-col); background-color: var(--bg-panel); color: var(--text-main); font-size: 1.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.1s, transform 0.1s; }
  .ctrl-btn:active { filter: brightness(0.8); transform: scale(0.9); }
  .btn-move { border-color: #3b82f6; color: #3b82f6; }
  .btn-del { background-color: var(--danger-color); border-color: var(--danger-color); color: #fff; width: 60px; }
  .btn-weight { border-color: #10b981; color: #10b981; border-radius: 50%; }
  .wc-label { font-size: 1.4rem; font-weight: bold; font-family: monospace; color: var(--accent-color); width: 80px; text-align: center; }

  @media (max-width: 768px) {
    .header-area { padding: 10px; position: static; }
    .control-bar { gap: 5px; }
    .panel-container, .inspection-container { flex-direction: column; }
    .image-panel { width: 100%; }
    .add-form { flex-direction: column; }
    .library-tag::before { display: none; }
    .pool-header { flex-wrap: wrap; gap: 10px; }
  }
  @media (min-width: 769px) {
    .library-tag::before { content: attr(data-en); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #111; color: #fff; padding: 6px 10px; border-radius: 4px; font-size: 0.8rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 2000; box-shadow: 0 4px 10px rgba(0,0,0,0.6); border: 1px solid #555; }
    .library-tag:hover::before { opacity: 1; bottom: 120%; }
  }
  
  .btn-small { padding: 8px 12px; font-size: 0.85rem; border-radius: 4px; border: none; cursor: pointer; color: #fff; }
  .btn-copy { background-color: #3b82f6; }
  .btn-add { background-color: #10b981; }
  .btn-exec-trans { background-color: #f59e0b; font-weight: bold; }
  #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 12px; position: fixed; z-index: 3000; bottom: 30px; left: 50%; transform: translateX(-50%); border-left: 5px solid var(--accent-color); opacity: 0; transition: opacity 0.3s; }
  #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
</style>
</head>
<body>

<div class="header-area">
  <h1>SD Prompt Manager Ultimate</h1>
  <div class="output-container" id="output-area">
    <div class="pool-header">
        <div class="output-label">
          <span>Prompt Chain</span>
          <span id="total-count">0 words</span>
        </div>
        <div class="pool-actions">
            <button class="action-btn btn-pool btn-undo" id="btn-undo" onclick="undo()" disabled title="Undo">‚Ü©Ô∏è</button>
            <button class="action-btn btn-pool btn-undo" id="btn-redo" onclick="redo()" disabled title="Redo">‚Ü™Ô∏è</button>
            <button class="action-btn btn-pool btn-save" onclick="saveTxt()" title="Save text">üíæ .txt</button>
            <button class="action-btn btn-pool btn-copy" onclick="copyFullPrompt()">Copy</button>
            <button class="action-btn btn-pool btn-clear" onclick="clearPool()">Clear</button>
        </div>
    </div>
    <div id="prompt-pool"></div>
  </div>
  <div class="toolbar-container">
    <div class="toolbar-row-main">
        <input type="text" id="search-input" class="search-input" placeholder="Search tags...">
        <button class="action-btn btn-save" onclick="downloadJson()" title="Save DB">üíæ JSON</button>
        <button class="action-btn btn-load" style="background-color:#059669;" onclick="document.getElementById('file-input').click()" title="Load DB">üìÇ Load</button>
        <input type="file" id="file-input" style="display: none;" accept=".json" onchange="loadJsonFile(this)">
    </div>
    <div class="toolbar-row-tools">
        <button class="action-btn btn-free" onclick="togglePanel('free-edit-panel')" title="Free Edit">üìù Free</button>
        <button class="action-btn btn-wild" onclick="togglePanel('wildcard-panel')" title="Wildcards">üÉè Wild</button>
        <button class="action-btn btn-toggle" onclick="togglePanel('inspection-panel')" title="PNG Info">üëÅÔ∏è PNG</button>
        <button class="action-btn btn-trans" onclick="togglePanel('translation-panel')" title="Translate">üåê Trans</button>
        <button class="action-btn btn-theme" onclick="toggleTheme()" title="Theme">üåó</button>
        <button class="action-btn btn-edit" id="btn-edit-mode" onclick="toggleEditMode()">‚úèÔ∏è Edit</button>
    </div>
  </div>
</div>

<div class="content-area">
  <div class="panel-container hidden" id="free-edit-panel">
    <div class="meta-label">üìù Free Prompt Editor</div>
    <div class="free-edit-box">
        <textarea id="free-textarea" class="free-textarea" placeholder="Type prompt here..."></textarea>
        <div id="autocomplete-list"></div>
        <div class="meta-actions">
            <button class="btn-small btn-copy" onclick="copyFreeText()">Copy</button>
            <button class="btn-small btn-add" onclick="addFreeToPool()">Add to Pool</button>
        </div>
    </div>
  </div>
  <div class="panel-container hidden" id="wildcard-panel">
    <div class="meta-label">üÉè Wildcard File Creator</div>
    <div class="free-edit-box">
        <div class="wildcard-row">
            <span>Filename:</span>
            <input type="text" id="wild-name" class="wild-input-name" placeholder="my_outfits">
            <span>.txt</span>
        </div>
        <textarea id="wild-content" class="free-textarea" placeholder="Enter words..."></textarea>
        <div class="meta-actions">
            <button class="btn-small btn-save" onclick="saveWildcard()">Download .txt</button>
        </div>
    </div>
  </div>
  <div class="panel-container hidden" id="translation-panel">
    <div class="trans-box">
      <div class="meta-label">JP ‚Üî EN Translator</div>
      <div class="trans-row">
        <div class="input-wrapper">
            <input type="text" id="trans-input" class="trans-input" placeholder="Enter text..." onkeydown="if(event.key==='Enter') execTranslate()">
            <button class="btn-input-clear" onclick="clearTransInput()">√ó</button>
        </div>
        <button class="btn-small btn-exec-trans" onclick="execTranslate()">Go</button>
      </div>
      <div class="trans-row">
        <div id="trans-result" class="trans-result"></div>
        <button class="btn-small btn-add" onclick="addTransToPool()">Add</button>
      </div>
    </div>
  </div>
  <div class="panel-container hidden" id="inspection-panel">
    <div class="inspection-container">
      <div class="meta-panel">
        <div class="meta-label">Extracted Data (PNG Info)</div>
        <textarea id="meta-textarea" class="meta-textarea" placeholder="Drop image here..."></textarea>
        <div class="meta-actions">
          <button class="btn-small btn-copy" onclick="copyMeta()">Copy</button>
          <button class="btn-small btn-add" onclick="addMetaToPool()">Add</button>
        </div>
      </div>
      <div class="image-panel">
        <div class="ref-box" id="ref-drop-zone">
          <div class="ref-text" id="ref-text">Drop / Paste</div>
          <img src="" alt="Reference" class="ref-preview" id="ref-preview">
          <button class="btn-remove-img" id="btn-remove-img" onclick="clearImage()">√ó</button>
        </div>
      </div>
    </div>
  </div>

  <div class="add-section">
    <span class="add-label-title">üëá Add New Prompt Here („Åì„Åì„Åã„ÇâËøΩÂä†)</span>
    <div class="add-form">
      <select id="new-cat-select" class="add-select"></select>
      <input type="text" id="new-word-input" class="add-input" placeholder="Add tag (e.g. cat, Áå´)">
      <button class="action-btn btn-add" onclick="addNewWord()">Add</button>
    </div>
  </div>

  <div id="library-area"></div>
  
  <div class="add-group-btn-area">
    <button class="btn-add-group" onclick="openModal()">Ôºã Add New Group</button>
  </div>

  <footer class="app-footer">
    <p style="display: flex; align-items: center; justify-content: center;">
  Created by <span class="creator-name">Nuruneko</span>
  <img src="logo.png" alt="icon" style="height: 40px; margin-left: 10px; border-radius: 5px;">
</p>
    <div class="social-links">
      <a href="https://x.com/nuruneko3710" target="_blank">X (Twitter)</a> |
      <a href="https://www.patreon.com/NurunekoAIillust" target="_blank">Patreon</a>
    </div>
  </footer>
</div>

<div id="controller-bar">
  <div class="ctrl-row-move">
    <button class="ctrl-btn btn-move" onclick="moveTag(-1)">‚¨ÖÔ∏è</button>
    <button class="ctrl-btn btn-del" onclick="deleteSelectedTag()">üóëÔ∏è</button>
    <button class="ctrl-btn btn-move" onclick="moveTag(1)">‚û°Ô∏è</button>
  </div>
  <div class="ctrl-row-weight">
    <button class="ctrl-btn btn-weight" onclick="adjustWeight(-0.1)">‚ûñ</button>
    <div class="wc-label" id="wc-display">1.0</div>
    <button class="ctrl-btn btn-weight" onclick="adjustWeight(0.1)">‚ûï</button>
  </div>
</div>

<div id="modal-overlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">Create New Group</div>
    <label id="lbl-gname">Group Name (Parent):</label>
    <input type="text" id="modal-group-name" class="modal-input" placeholder="Group Name">
    <div id="cat-name-container">
      <label>Sub-Category Name:</label>
      <input type="text" id="modal-cat-name" class="modal-input" placeholder="Category Name">
    </div>
    <div id="color-picker-container" class="color-picker-row">
        <label>Color:</label>
        <input type="color" id="modal-color" class="color-input" value="#3b82f6">
    </div>
    <div class="modal-btns">
        <button class="btn-small btn-clear" onclick="closeModal()">Cancel</button>
        <button class="btn-small btn-add" id="modal-save-btn" onclick="saveNewGroup()">Create</button>
    </div>
  </div>
</div>
<div id="tag-modal-overlay" class="modal-overlay">
  <div class="modal-box">
    <div class="modal-title">Edit Tag</div>
    <label>English (Prompt):</label>
    <input type="text" id="tag-en-input" class="modal-input">
    <label>Japanese (Display):</label>
    <input type="text" id="tag-jp-input" class="modal-input">
    <div class="modal-btns">
        <button class="btn-small btn-clear" onclick="closeTagModal()">Cancel</button>
        <button class="btn-small btn-add" onclick="saveTagEdit()">Save</button>
    </div>
  </div>
</div>

<div id="toast">Copied!</div>

<script>
  let allData = [];
  const pool = document.getElementById('prompt-pool');
  const library = document.getElementById('library-area');
  const catSelect = document.getElementById('new-cat-select');
  const toast = document.getElementById('toast');
  const wcBar = document.getElementById('controller-bar');
  const wcDisplay = document.getElementById('wc-display');
  let selectedTagElement = null;
  let isEditMode = false;
  const historyStack = []; const redoStack = []; const MAX_HISTORY = 20;
  let currentEditTarget = null; 
  const expandedGroups = new Set(); const expandedCats = new Set();

  function recordHistory() { if (historyStack.length >= MAX_HISTORY) historyStack.shift(); historyStack.push(JSON.stringify(allData)); redoStack.length = 0; updateUndoRedoUI(); }
  function undo() { if (historyStack.length === 0) return; redoStack.push(JSON.stringify(allData)); allData = JSON.parse(historyStack.pop()); saveToStorage(false); renderLibrary(isEditMode); updateCategorySelect(); updateUndoRedoUI(); showToast("Undo"); }
  function redo() { if (redoStack.length === 0) return; historyStack.push(JSON.stringify(allData)); allData = JSON.parse(redoStack.pop()); saveToStorage(false); renderLibrary(isEditMode); updateCategorySelect(); updateUndoRedoUI(); showToast("Redo"); }
  function updateUndoRedoUI() { document.getElementById('btn-undo').disabled = historyStack.length === 0; document.getElementById('btn-redo').disabled = redoStack.length === 0; }

  function togglePanel(panelId) { const panel = document.getElementById(panelId); if (panel.classList.contains('hidden')) { document.querySelectorAll('.panel-container').forEach(p => p.classList.add('hidden')); panel.classList.remove('hidden'); } else { panel.classList.add('hidden'); } }
  function toggleTheme() { document.body.classList.toggle('light-mode'); localStorage.setItem('sd_theme_mode', document.body.classList.contains('light-mode') ? 'light' : 'dark'); }
  function toggleEditMode() { isEditMode = !isEditMode; document.body.classList.toggle('is-editing', isEditMode); const btn = document.getElementById('btn-edit-mode'); if(isEditMode) { btn.classList.add('active'); btn.innerText = "‚úèÔ∏è Editing..."; showToast("Edit Mode ON"); enableDragDropLibrary(); } else { btn.classList.remove('active'); btn.innerText = "‚úèÔ∏è Edit"; showToast("Edit Mode OFF"); renderLibrary(); } }
  
  function toggleGroup(gIdx, groupName) {
      if(expandedGroups.has(groupName)) expandedGroups.delete(groupName); else expandedGroups.add(groupName);
      renderLibrary(isEditMode);
  }
  function toggleCat(cName) {
      if(expandedCats.has(cName)) expandedCats.delete(cName); else expandedCats.add(cName);
      renderLibrary(isEditMode);
  }

  const modalOverlay = document.getElementById('modal-overlay');
  const tagModalOverlay = document.getElementById('tag-modal-overlay');
  const modalTitle = document.getElementById('modal-title');
  const modalGroupInput = document.getElementById('modal-group-name');
  const modalCatInput = document.getElementById('modal-cat-name');
  const catNameContainer = document.getElementById('cat-name-container');
  const modalColorInput = document.getElementById('modal-color');
  const modalColorContainer = document.getElementById('color-picker-container');
  const modalSaveBtn = document.getElementById('modal-save-btn');

  function openModal() {
    currentEditTarget = { type: 'new_group' };
    modalTitle.innerText = "Create New Group";
    modalGroupInput.value = ''; modalCatInput.value = ''; modalColorInput.value = '#3b82f6';
    document.getElementById('lbl-gname').innerText = "Group Name (Parent):";
    modalGroupInput.style.display = 'block'; catNameContainer.style.display = 'block'; modalColorContainer.style.display = 'flex';
    modalSaveBtn.onclick = saveNewGroup; modalSaveBtn.innerText = "Create";
    modalOverlay.classList.add('active');
  }
  function openRenameGroupModal(gIdx) {
    currentEditTarget = { type: 'rename_group', gIdx };
    modalTitle.innerText = "Rename Group";
    modalGroupInput.value = allData[gIdx].group;
    document.getElementById('lbl-gname').innerText = "Group Name:";
    modalGroupInput.style.display = 'block'; catNameContainer.style.display = 'none'; modalColorContainer.style.display = 'none'; 
    modalSaveBtn.onclick = saveRenameGroup; modalSaveBtn.innerText = "Save";
    modalOverlay.classList.add('active');
  }
  function openRenameCatModal(gIdx, cIdx) {
    currentEditTarget = { type: 'rename_cat', gIdx, cIdx };
    modalTitle.innerText = "Edit Category";
    modalGroupInput.style.display = 'none'; document.getElementById('lbl-gname').innerText = "";
    const cat = allData[gIdx].items[cIdx];
    document.querySelector('#cat-name-container label').innerText = "Category Name:";
    modalCatInput.value = cat.category;
    catNameContainer.style.display = 'block'; modalColorContainer.style.display = 'flex';
    let colorVal = cat.colorVar;
    if (colorVal.startsWith('--')) {
        const tempSpan = document.createElement('span'); tempSpan.style.color = `var(${colorVal})`; document.body.appendChild(tempSpan);
        const rgb = getComputedStyle(tempSpan).color; document.body.removeChild(tempSpan);
        colorVal = rgbToHex(rgb);
    }
    modalColorInput.value = colorVal;
    modalSaveBtn.onclick = saveRenameCat; modalSaveBtn.innerText = "Save";
    modalOverlay.classList.add('active');
  }
  function openTagEditModal(gIdx, cIdx, wIdx) {
    currentEditTarget = { type: 'edit_tag', gIdx, cIdx, wIdx };
    const word = allData[gIdx].items[cIdx].words[wIdx];
    document.getElementById('tag-en-input').value = word.en; document.getElementById('tag-jp-input').value = word.jp;
    tagModalOverlay.classList.add('active');
  }
  function closeModal() { modalOverlay.classList.remove('active'); }
  function closeTagModal() { tagModalOverlay.classList.remove('active'); }

  function rgbToHex(rgb) {
    if(!rgb || rgb.indexOf('rgb') === -1) return '#000000';
    const rgbValues = rgb.match(/\d+/g).map(Number);
    return "#" + rgbValues.map(x => x.toString(16).padStart(2, '0')).join('');
  }

  function saveNewGroup() { const gName = modalGroupInput.value.trim(); const cName = modalCatInput.value.trim(); const color = modalColorInput.value; if(!gName || !cName) { alert("Enter names"); return; } recordHistory(); allData.push({ group: gName, items: [{ category: cName, colorVar: color, words: [] }] }); saveToStorage(false); renderLibrary(isEditMode); updateCategorySelect(); closeModal(); showToast("Created!"); }
  function saveRenameGroup() { const newName = modalGroupInput.value.trim(); if(!newName) return; recordHistory(); allData[currentEditTarget.gIdx].group = newName; saveToStorage(false); renderLibrary(isEditMode); closeModal(); }
  function saveRenameCat() { const newName = modalCatInput.value.trim(); if(!newName) return; recordHistory(); allData[currentEditTarget.gIdx].items[currentEditTarget.cIdx].category = newName; allData[currentEditTarget.gIdx].items[currentEditTarget.cIdx].colorVar = modalColorInput.value; saveToStorage(false); renderLibrary(isEditMode); closeModal(); }
  function saveTagEdit() { const newEn = document.getElementById('tag-en-input').value.trim(); const newJp = document.getElementById('tag-jp-input').value.trim(); if(!newEn) return; recordHistory(); const {gIdx, cIdx, wIdx} = currentEditTarget; allData[gIdx].items[cIdx].words[wIdx].en = newEn; allData[gIdx].items[cIdx].words[wIdx].jp = newJp; saveToStorage(false); renderLibrary(isEditMode); closeTagModal(); }

  let dragSrcLib = null; let dragType = null; function enableDragDropLibrary() { renderLibrary(true); }
  function deleteGroup(gIdx) { if(confirm(`Delete Group "${allData[gIdx].group}"?`)) { recordHistory(); allData.splice(gIdx, 1); saveToStorage(false); renderLibrary(isEditMode); updateCategorySelect(); } }
  
  function renderLibrary(editable = false) {
    library.innerHTML = ''; 
    allData.forEach((group, gIdx) => {
      const groupBox = document.createElement('div');
      const isOpen = expandedGroups.has(group.group);
      groupBox.className = isOpen ? 'group-box' : 'group-box collapsed';
      
      if(editable) { groupBox.draggable = true; addLibDragEvents(groupBox, 'group', gIdx); }

      const header = document.createElement('div'); header.className = 'group-header';
      
      const titleArea = document.createElement('div');
      titleArea.style.display = 'flex'; titleArea.style.alignItems = 'center';
      if(editable) titleArea.innerHTML = `<span class="drag-handle">‚â°</span> <span>${group.group}</span>`;
      else titleArea.innerHTML = `<span>${group.group}</span>`;
      header.appendChild(titleArea);

      if(editable) {
          const controls = document.createElement('div'); controls.className = 'edit-actions';
          const editBtn = document.createElement('button'); editBtn.className = 'btn-icon'; editBtn.innerHTML = '‚úé';
          editBtn.onclick = (e) => { e.stopPropagation(); openRenameGroupModal(gIdx); }; 
          const delBtn = document.createElement('button'); delBtn.className = 'btn-icon-del'; delBtn.innerHTML = 'üóëÔ∏è';
          delBtn.onclick = (e) => { e.stopPropagation(); deleteGroup(gIdx); }; 
          controls.appendChild(editBtn); controls.appendChild(delBtn);
          header.appendChild(controls);
      } else {
          const icon = document.createElement('span'); icon.className = 'group-icon'; icon.innerText = '‚ñº';
          header.appendChild(icon);
      }
      
      header.onclick = () => toggleGroup(gIdx, group.group);
      groupBox.appendChild(header);

      const body = document.createElement('div'); body.className = 'group-body';
      
      group.items.forEach((cat, cIdx) => {
        const catBox = document.createElement('div');
        const isCatOpen = expandedCats.has(cat.category);
        catBox.className = isCatOpen ? 'category-box' : 'category-box collapsed';
        const colorStyle = cat.colorVar.startsWith('--') ? `var(${cat.colorVar})` : cat.colorVar; catBox.style.setProperty('--box-color', colorStyle);
        if(editable) { catBox.draggable = true; addLibDragEvents(catBox, 'category', gIdx, cIdx); }

        const catTitle = document.createElement('div'); catTitle.className = 'category-title';
        const catNameArea = document.createElement('div');
        catNameArea.style.display = 'flex'; catNameArea.style.alignItems = 'center';
        if(editable) catNameArea.innerHTML = `<span class="drag-handle">‚â°</span> <span>${cat.category}</span>`;
        else catNameArea.innerHTML = `<span>${cat.category}</span>`;
        
        if(!editable) {
            const randBtn = document.createElement('button'); randBtn.className = 'btn-random-pick'; randBtn.innerText = 'üé≤';
            randBtn.onclick = (e) => { e.stopPropagation(); pickRandom(gIdx, cIdx, cat.colorVar); };
            catNameArea.insertBefore(randBtn, catNameArea.firstChild);
        }
        catTitle.appendChild(catNameArea);

        if(editable) {
            const controls = document.createElement('div'); controls.className = 'edit-actions';
            const editBtn = document.createElement('button'); editBtn.className = 'btn-icon'; editBtn.innerHTML = '‚úé';
            editBtn.onclick = (e) => { e.stopPropagation(); openRenameCatModal(gIdx, cIdx); };
            controls.appendChild(editBtn);
            catTitle.appendChild(controls);
        } else {
            const icon = document.createElement('span'); icon.className = 'cat-icon'; icon.innerText = '‚ñº';
            catTitle.appendChild(icon);
        }

        catTitle.onclick = (e) => { e.stopPropagation(); toggleCat(cat.category); };
        catBox.appendChild(catTitle);

        const tagContainer = document.createElement('div'); tagContainer.className = 'tag-container';
        cat.words.forEach((w, wIdx) => {
            const btn = document.createElement('span'); btn.className = 'library-tag'; btn.innerText = w.jp || w.en; btn.setAttribute('data-en', w.en);
            const tagColor = cat.colorVar.startsWith('--') ? `var(${cat.colorVar})` : cat.colorVar; btn.style.setProperty('--tag-color', tagColor);
            if(editable) {
                const dragIcon = document.createElement('span'); dragIcon.className = 'drag-handle'; dragIcon.innerText = '::'; dragIcon.style.fontSize='0.8rem'; dragIcon.style.marginRight='4px';
                btn.prepend(dragIcon);
                btn.draggable = true; addLibDragEvents(btn, 'word', gIdx, cIdx, wIdx);
                const editIcon = document.createElement('span'); editIcon.className='btn-icon'; editIcon.innerHTML = '‚úé'; editIcon.style.marginLeft='5px'; editIcon.style.fontSize='0.7rem'; editIcon.style.padding='1px 4px';
                btn.appendChild(editIcon);
                editIcon.onclick = (e) => { e.stopPropagation(); openTagEditModal(gIdx, cIdx, wIdx); };
            } else {
                btn.onclick = () => handleTagClick(w.en, cat.colorVar);
                btn.oncontextmenu = (e) => { e.preventDefault(); if(confirm(`Delete "${w.en}"?`)) { recordHistory(); cat.words.splice(wIdx,1); saveToStorage(false); renderLibrary(); } };
            }
            tagContainer.appendChild(btn);
        });
        catBox.appendChild(tagContainer); body.appendChild(catBox);
      });
      groupBox.appendChild(body); library.appendChild(groupBox);
    });
  }

  function addLibDragEvents(el, type, gIdx, cIdx = null, wIdx = null) {
    el.addEventListener('dragstart', function(e) { e.stopPropagation(); dragSrcLib = { type, gIdx, cIdx, wIdx, el: this }; dragType = type; this.style.opacity = '0.4'; e.dataTransfer.effectAllowed = 'move'; });
    el.addEventListener('dragend', function(e) { e.stopPropagation(); this.style.opacity = '1'; dragSrcLib = null; document.querySelectorAll('.drag-over-target').forEach(el => el.classList.remove('drag-over-target')); });
    el.addEventListener('dragenter', function(e) { e.preventDefault(); e.stopPropagation(); if(dragType === type && dragSrcLib.el !== this) this.classList.add('drag-over-target'); });
    el.addEventListener('dragleave', function(e) { e.preventDefault(); e.stopPropagation(); this.classList.remove('drag-over-target'); });
    el.addEventListener('dragover', function(e) { e.preventDefault(); e.stopPropagation(); if(dragType === type) return false; });
    el.addEventListener('drop', function(e) {
        e.stopPropagation(); this.classList.remove('drag-over-target');
        if (dragSrcLib && dragSrcLib.el !== this && dragSrcLib.type === type) {
            recordHistory();
            if (type === 'group') { 
                const item = allData.splice(dragSrcLib.gIdx, 1)[0]; 
                allData.splice(gIdx, 0, item); 
            }
            else if (type === 'category') { 
                const item = allData[dragSrcLib.gIdx].items.splice(dragSrcLib.cIdx, 1)[0];
                allData[gIdx].items.splice(cIdx, 0, item);
                expandedGroups.add(allData[gIdx].group); 
            }
            else if (type === 'word') {
                const item = allData[dragSrcLib.gIdx].items[dragSrcLib.cIdx].words.splice(dragSrcLib.wIdx, 1)[0];
                allData[gIdx].items[cIdx].words.splice(wIdx, 0, item);
                expandedGroups.add(allData[gIdx].group);
                expandedCats.add(allData[gIdx].items[cIdx].category);
            }
            saveToStorage(false); renderLibrary(true);
        } return false;
    });
  }

  // ... (Standard Functions)
  const freeTextarea = document.getElementById('free-textarea'); const autoList = document.getElementById('autocomplete-list');
  if(freeTextarea) { freeTextarea.addEventListener('input', function(e) { const val = this.value; const cursor = this.selectionStart; const textBefore = val.substring(0, cursor); const match = textBefore.match(/([a-zA-Z0-9_]+)$/); if (match) { const query = match[1].toLowerCase(); if(query.length < 2) { autoList.style.display = 'none'; return; } showSuggestions(query, cursor); } else { autoList.style.display = 'none'; } }); }
  function showSuggestions(query, cursor) { autoList.innerHTML = ''; let count = 0; for (const group of allData) { for (const cat of group.items) { for (const word of cat.words) { if (word.en.toLowerCase().includes(query)) { const div = document.createElement('div'); div.className = 'suggestion-item'; div.innerHTML = `<span class="sug-en">${word.en}</span> <span class="sug-jp">${word.jp || ''}</span>`; div.onclick = () => insertWord(word.en, query.length); autoList.appendChild(div); count++; if(count > 10) break; } } if(count > 10) break; } if(count > 10) break; } if (count > 0) autoList.style.display = 'block'; else autoList.style.display = 'none'; }
  function insertWord(word, queryLen) { const val = freeTextarea.value; const cursor = freeTextarea.selectionStart; const before = val.substring(0, cursor - queryLen); const after = val.substring(cursor); freeTextarea.value = before + word + after; autoList.style.display = 'none'; freeTextarea.focus(); }
  function copyFreeText() { navigator.clipboard.writeText(freeTextarea.value).then(() => showToast("Copied!")); }
  function addFreeToPool() { const text = freeTextarea.value; if(!text) return; const parts = text.split(/[,\n]/); parts.forEach(p => { const t = p.trim(); if(t) addToPool(t, '--col-quality'); }); }
  function saveWildcard() { const name = document.getElementById('wild-name').value.trim() || "wildcard"; let content = document.getElementById('wild-content').value; content = content.replace(/,/g, '\n').split('\n').map(s => s.trim()).filter(s => s).join('\n'); const blob = new Blob([content], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${name}.txt`; a.click(); }
  function saveTxt() { const tags = Array.from(pool.children).map(span => span.innerText); const content = tags.join(', '); const blob = new Blob([content], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `prompt_${new Date().toISOString().slice(0,10)}.txt`; a.click(); }
  
  function clearTransInput() { const input = document.getElementById('trans-input'); if(input) { input.value = ''; input.focus(); } }
  async function execTranslate() {
    const input = document.getElementById('trans-input'); const resultBox = document.getElementById('trans-result'); const text = input.value.trim(); if (!text) return;
    resultBox.innerText = "..."; const hasJapanese = /[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/.test(text); const langPair = hasJapanese ? "ja|en" : "en|ja"; try { const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${langPair}`); if(!response.ok) throw new Error("API Status: "+response.status); const data = await response.json(); if (data.responseData && data.responseData.translatedText) resultBox.innerText = data.responseData.translatedText; else resultBox.innerText = "Error: "+(data.responseDetails||"Unknown"); } catch (err) { resultBox.innerText = "Net Error"; }
  }
  function addTransToPool() { const resultBox = document.getElementById('trans-result'); const text = resultBox.innerText; if (!text || text.startsWith("...") || text.includes("Error")) return; addToPool(text, '--col-quality'); }
  
  const refZone = document.getElementById('ref-drop-zone'); const refPreview = document.getElementById('ref-preview'); const refText = document.getElementById('ref-text'); const btnRemove = document.getElementById('btn-remove-img'); const metaTextarea = document.getElementById('meta-textarea'); const inspectionPanel = document.getElementById('inspection-panel');
  document.addEventListener('paste', (e) => { const items = (e.clipboardData || e.originalEvent.clipboardData).items; for (let index in items) { if (items[index].kind === 'file' && items[index].type.includes('image')) { const file = items[index].getAsFile(); displayRefImage(file); readPngMetadata(file); document.querySelectorAll('.panel-container').forEach(p => p.classList.add('hidden')); inspectionPanel.classList.remove('hidden'); } } });
  refZone.addEventListener('dragover', (e) => { e.preventDefault(); refZone.classList.add('dragover'); }); refZone.addEventListener('dragleave', () => refZone.classList.remove('dragover'));
  refZone.addEventListener('drop', (e) => { e.preventDefault(); refZone.classList.remove('dragover'); if (e.dataTransfer.files.length > 0) { const file = e.dataTransfer.files[0]; displayRefImage(file); readPngMetadata(file); inspectionPanel.classList.remove('hidden'); } });
  function displayRefImage(file) { const reader = new FileReader(); reader.onload = (e) => { refPreview.src = e.target.result; refPreview.style.display = 'block'; refText.style.display = 'none'; btnRemove.style.display = 'block'; }; reader.readAsDataURL(file); }
  function clearImage() { refPreview.src = ''; refPreview.style.display = 'none'; refText.style.display = 'block'; btnRemove.style.display = 'none'; metaTextarea.value = ''; }
  function readPngMetadata(file) { if (file.type !== 'image/png') { metaTextarea.value = "Only PNG supported."; return; } const reader = new FileReader(); reader.onload = function(e) { const buffer = e.target.result; const view = new DataView(buffer); if (view.getUint32(0) !== 0x89504E47) return; let offset = 8; let extractedText = ""; while (offset < buffer.byteLength) { const length = view.getUint32(offset); const type = String.fromCharCode(view.getUint8(offset+4),view.getUint8(offset+5),view.getUint8(offset+6),view.getUint8(offset+7)); if (type === 'tEXt') { const dataStart = offset + 8; const dataArray = new Uint8Array(buffer, dataStart, length); let nullIndex = -1; for(let i=0; i<length; i++) { if(dataArray[i]===0) { nullIndex=i; break; } } if (nullIndex !== -1) { const keyword = new TextDecoder().decode(dataArray.slice(0, nullIndex)); if (keyword === 'parameters') { extractedText = new TextDecoder().decode(dataArray.slice(nullIndex+1)); break; } } } offset += 12 + length; } metaTextarea.value = extractedText || "No parameters found."; }; reader.readAsArrayBuffer(file); }
  function copyMeta() { if(!metaTextarea.value) return; navigator.clipboard.writeText(metaTextarea.value).then(() => showToast("Copied!")); }
  function addMetaToPool() { if(!metaTextarea.value) return; const text = metaTextarea.value.split('\n')[0]; addToPool(text, '--col-quality'); }

  document.addEventListener('DOMContentLoaded', () => {
    fetch('data.json').then(res => res.ok ? res.json() : []).then(json => {
        const processed = json.map(g => ({ ...g, items: g.items.map(c => ({ ...c, words: c.words.map(w => (typeof w === 'string' ? {en:w, jp:w} : w)) })) }));
        const saved = localStorage.getItem('sd_prompt_data_v38'); allData = saved ? JSON.parse(saved) : processed; renderLibrary(); updateCategorySelect();
    }).catch(console.error);
    const savedTheme = localStorage.getItem('sd_theme_mode'); if (savedTheme === 'light') document.body.classList.add('light-mode');
    document.addEventListener('click', (e) => { if (!e.target.closest('.active-tag') && !e.target.closest('#controller-bar') && !e.target.closest('.ctrl-btn')) { deselectAllTags(); } if (!e.target.closest('.free-edit-box')) autoList.style.display = 'none'; });
  });
  function pickRandom(gIdx, cIdx, colorVar) { const words = allData[gIdx].items[cIdx].words; if (words.length === 0) return; const randomWord = words[Math.floor(Math.random() * words.length)]; addToPool(randomWord.en, colorVar); showToast(`üé≤ Picked: ${randomWord.en}`); }
  function updateCategorySelect() { catSelect.innerHTML = ''; allData.forEach((g, gIdx) => { g.items.forEach((c, cIdx) => { const opt = document.createElement('option'); opt.value = `${gIdx}-${cIdx}`; opt.innerText = `${g.group} > ${c.category}`; catSelect.appendChild(opt); }); }); }
  function addNewWord() { const val = document.getElementById('new-word-input').value.trim(); if (!val) return; const [g, c] = catSelect.value.split('-').map(Number); let en = val, jp = val; if (val.includes(',')) { const p = val.split(','); en = p[0].trim(); jp = p[1].trim(); } const target = allData[g].items[c]; if (!target.words.some(w => w.en === en)) { recordHistory(); target.words.push({en, jp}); saveToStorage(false); renderLibrary(isEditMode); showToast(`Added: ${en}`); document.getElementById('new-word-input').value = ''; } else { alert('Exists'); } }
  function saveToStorage(record = true) { if(record) recordHistory(); localStorage.setItem('sd_prompt_data_v38', JSON.stringify(allData)); }
  function downloadJson() { const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2)); const dl = document.createElement('a'); dl.setAttribute("href", str); dl.setAttribute("download", "data.json"); document.body.appendChild(dl); dl.click(); dl.remove(); }
  function handleTagClick(word, colorVar) { navigator.clipboard.writeText(word).then(() => showToast(`Copied: "${word}"`)); addToPool(word, colorVar); }
  function addToPool(word, colorVar) { const span = document.createElement('span'); span.className = 'active-tag'; span.draggable = true; const tagColor = colorVar.startsWith('--') ? `var(${colorVar})` : colorVar; span.style.setProperty('--tag-color', tagColor); span.dataset.word = word; span.dataset.weight = "1.0"; span.innerText = word; span.onclick = (e) => { e.stopPropagation(); selectTag(span); }; span.oncontextmenu = (e) => { e.preventDefault(); span.remove(); updateCount(); deselectAllTags(); }; span.addEventListener('dragstart', function(e) { this.classList.add('dragging'); dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; }); span.addEventListener('dragend', function(e) { this.classList.remove('dragging'); }); span.addEventListener('dragover', (e) => { e.preventDefault(); return false; }); span.addEventListener('drop', function(e) { e.stopPropagation(); if (dragSrcEl !== this) { pool.insertBefore(dragSrcEl, this); } return false; }); span.addEventListener('wheel', function(e) { e.preventDefault(); if(!this.classList.contains('selected')) selectTag(this); updateWeight(this, e.deltaY < 0 ? 0.1 : -0.1); }); pool.appendChild(span); updateCount(); }
  let dragSrcEl = null;
  function selectTag(el) { deselectAllTags(); el.classList.add('selected'); selectedTagElement = el; wcBar.classList.add('visible'); wcDisplay.innerText = parseFloat(el.dataset.weight).toFixed(1); }
  function deselectAllTags() { pool.querySelectorAll('.active-tag').forEach(t => t.classList.remove('selected')); selectedTagElement = null; wcBar.classList.remove('visible'); }
  function adjustWeight(delta) { if(selectedTagElement) updateWeight(selectedTagElement, delta); }
  function updateWeight(el, delta) { let w = parseFloat(el.dataset.weight); w += delta; w = Math.round(w * 10) / 10; if (w > 3.0) w = 3.0; if (w < 0.1) w = 0.1; el.dataset.weight = w; const txt = el.dataset.word; el.innerText = (w === 1.0) ? txt : `(${txt}:${w.toFixed(1)})`; if(wcDisplay) wcDisplay.innerText = w.toFixed(1); }
  function moveTag(direction) { if(!selectedTagElement) return; if (direction === -1) { if (selectedTagElement.previousElementSibling) pool.insertBefore(selectedTagElement, selectedTagElement.previousElementSibling); } else { if (selectedTagElement.nextElementSibling) pool.insertBefore(selectedTagElement, selectedTagElement.nextElementSibling.nextElementSibling); } }
  function deleteSelectedTag() { if(selectedTagElement) { selectedTagElement.remove(); deselectAllTags(); updateCount(); } }
  function copyFullPrompt() { const tags = Array.from(pool.children).map(span => span.innerText); navigator.clipboard.writeText(tags.join(', ')).then(() => showToast("All Copied!")); }
  function clearPool() { pool.innerHTML = ''; updateCount(); deselectAllTags(); }
  function updateCount() { document.getElementById('total-count').innerText = pool.children.length + " words"; }
  function showToast(msg) { toast.innerText = msg; toast.className = "show"; setTimeout(() => toast.className = toast.className.replace("show", ""), 3000); }
  document.getElementById('search-input').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.group-box').forEach(groupBox => {
        let groupHasMatch = false;
        groupBox.querySelectorAll('.category-box').forEach(catBox => {
            let catHasMatch = false;
            catBox.querySelectorAll('.library-tag').forEach(tag => {
                const jpText = tag.innerText.toLowerCase(); const enText = tag.getAttribute('data-en').toLowerCase();
                if (jpText.includes(term) || enText.includes(term)) { tag.classList.remove('hidden'); catHasMatch = true; groupHasMatch = true; } else { tag.classList.add('hidden'); }
            });
            if (catHasMatch) { catBox.classList.remove('hidden'); if(term.length > 0) catBox.classList.remove('collapsed'); } else { catBox.classList.add('hidden'); }
        });
        if (groupHasMatch) { groupBox.style.display = 'block'; if(term.length > 0) groupBox.classList.remove('collapsed'); } else { groupBox.style.display = 'none'; }
    });
  });
</script>
</body>
</html>